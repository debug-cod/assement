<?php global $search, $petOwnerModel, $totalPages, $page;
include 'template/header.phtml'; ?>

    <div class="row">
        <div class="col-md-12">
            <h2 class="text-center">Manage My Pets</h2>

            <!-- Error message display -->
            <?php if (isset($error_message) && $error_message): ?>
                <div class="alert alert-danger">
                    <?php echo htmlspecialchars($error_message); ?>
                </div>
            <?php endif; ?>

            <!-- Success message display -->
            <?php if (isset($success_message) && $success_message): ?>
                <div class="alert alert-success">
                    <?php echo htmlspecialchars($success_message); ?>
                </div>
            <?php endif; ?>

            <!-- Search Form -->
            <div class="well">
                <form method="get" action="manage_pets.php" class="form-inline">
                    <div class="form-group" style="width: 80%;">
                        <input type="text" class="form-control" name="search"
                               placeholder="Search in name, species, breed, color, description, status..."
                               value="<?php echo htmlspecialchars($search); ?>" style="width: 100%;">
                    </div>
                    <button type="submit" class="btn btn-primary">Search</button>
                    <?php if (!empty($search)): ?>
                        <a href="manage_pets.php" class="btn btn-default">Clear Search</a>
                    <?php endif; ?>
                </form>
            </div>

            <!-- Pets Grid -->
            <?php if (empty($userPets)): ?>
                <!-- No pets message -->
                <div class="alert alert-info text-center">
                    <?php if (!empty($search)): ?>
                        No pets found matching your search criteria.
                    <?php else: ?>
                        You haven't added any pets yet.
                    <?php endif; ?>
                </div>
            <?php else: ?>
                <div class="row">
                    <?php foreach ($userPets as $pet): ?>
                        <div class="col-md-4 col-sm-6">
                            <!-- Pet card panel -->
                            <div class="panel panel-default" style="min-height: 500px;">
                                <div class="panel-heading">
                                    <h4 class="panel-title">
                                        <?php echo htmlspecialchars($pet['name']); ?>
                                        <!-- Status label -->
                                        <span class="label <?php echo $pet['status'] == 'lost' ? 'label-danger' : 'label-success'; ?> pull-right">
                                        <?php echo htmlspecialchars($pet['status']); ?>
                                    </span>
                                    </h4>
                                </div>
                                <div class="panel-body">
                                    <!-- Pet Image -->
                                    <div class="text-center">
                                        <img src="../images/pet-image/<?php echo htmlspecialchars($pet['photo_url']); ?>"
                                             alt="<?php echo htmlspecialchars($pet['name']); ?>"
                                             class="img-responsive" style="max-height: 150px; margin: 0 auto;"
                                             onerror="this.src='../images/pet-image/default-pet.png'">
                                    </div>

                                    <!-- Pet Details -->
                                    <div class="pet-details" style="margin-top: 15px;">
                                        <p><strong>Species:</strong> <?php echo htmlspecialchars($pet['species']); ?></p>
                                        <p><strong>Breed:</strong> <?php echo htmlspecialchars($pet['breed']); ?></p>
                                        <p><strong>Color:</strong> <?php echo htmlspecialchars($pet['color']); ?></p>
                                        <p><strong>Gender:</strong> <?php echo htmlspecialchars($pet['gender']); ?></p>
                                        <p><strong>Age:</strong> <?php echo htmlspecialchars($pet['age']); ?> years</p>
                                        <p><strong>Description:</strong> <?php echo htmlspecialchars($pet['description']); ?></p>
                                        <p><strong>Reported:</strong> <?php echo htmlspecialchars($pet['date_reported']); ?></p>
                                        <p><strong>Total Reward:</strong> £<?php echo number_format($pet['total_reward'], 2); ?></p>
                                        <p><strong>Sightings:</strong> <?php echo htmlspecialchars($pet['sighting_count']); ?></p>
                                    </div>

                                    <!-- Sighting Information -->
                                    <?php
                                    $sightings = $petOwnerModel->getSightingsByPet($pet['id']);
                                    if (!empty($sightings)):
                                        ?>
                                        <div class="sighting-info" style="border-top: 1px solid #eee; padding-top: 10px; margin-top: 10px;">
                                            <h5>Recent Sightings:</h5>
                                            <?php foreach (array_slice($sightings, 0, 2) as $sighting): ?>
                                                <div style="margin-bottom: 8px; padding: 5px; background: #f9f9f9;">
                                                    <small>
                                                        <strong>Location:</strong> <?php echo htmlspecialchars($sighting['latitude'] . ', ' . $sighting['longitude']); ?><br>
                                                        <strong>Comment:</strong> <?php echo htmlspecialchars($sighting['comment']); ?><br>
                                                        <strong>Time:</strong> <?php echo htmlspecialchars($sighting['timestamp']); ?>
                                                    </small>
                                                </div>
                                            <?php endforeach; ?>
                                            <?php if (count($sightings) > 2): ?>
                                                <small>... and <?php echo count($sightings) - 2; ?> more sightings</small>
                                            <?php endif; ?>
                                        </div>
                                    <?php endif; ?>

                                    <!-- Action Buttons -->
                                    <div class="text-center" style="margin-top: 15px;">
                                        <a href="report_pet.php?edit_id=<?php echo $pet['id']; ?>"
                                           class="btn btn-primary btn-sm">Modify</a>
                                        <a href="manage_pets.php?delete_id=<?php echo $pet['id']; ?>"
                                           class="btn btn-danger btn-sm"
                                           onclick="return confirmDeletePet()">Delete</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <?php endforeach; ?>
                </div>

                <!-- Pagination -->
                <?php if ($totalPages > 1): ?>
                    <div class="row">
                        <div class="col-xs-12 text-center">
                            <ul class="pagination">
                                <?php if ($page > 1): ?>
                                    <li><a href="?<?php echo http_build_query(array_merge($_GET, ['page' => $page - 1])); ?>">← Previous</a></li>
                                <?php endif; ?>

                                <?php
                                $startPage = max(1, $page - 2);
                                $endPage = min($totalPages, $startPage + 4);
                                $startPage = max(1, $endPage - 4);

                                for ($i = $startPage; $i <= $endPage; $i++): ?>
                                    <li class="<?php echo $i == $page ? 'active' : ''; ?>">
                                        <a href="?<?php echo http_build_query(array_merge($_GET, ['page' => $i])); ?>"><?php echo $i; ?></a>
                                    </li>
                                <?php endfor; ?>

                                <?php if ($page < $totalPages): ?>
                                    <li><a href="?<?php echo http_build_query(array_merge($_GET, ['page' => $page + 1])); ?>">Next →</a></li>
                                <?php endif; ?>
                            </ul>
                        </div>
                    </div>
                <?php endif; ?>
            <?php endif; ?>

            <!-- Navigation Buttons -->
            <div class="text-center" style="margin-top: 30px;">
                <a href="../index.php" class="btn btn-default">Home</a>
                <a href="help.php" class="btn btn-default">Help</a>
                <a href="report_pet.php" class="btn btn-default">Report New Pet</a>
            </div>
        </div>
    </div>

    <script>
        // Simple confirmation function for pet deletion
        function confirmDeletePet() {
            return confirm("Are you sure you want to delete this pet? This will also remove all associated sightings and cannot be undone.");
        }
    </script>

<?php include 'template/footer.phtml'; ?>