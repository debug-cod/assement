<?php global $lostPets;
include 'template/header.phtml'; ?>

    <div class="row">
        <div class="col-md-8 col-md-offset-2">
            <h2 class="text-center">Report New Sighting</h2>

            <?php if (isset($error_message) && $error_message): ?>
                <div class="alert alert-danger">
                    <?php echo htmlspecialchars($error_message); ?>
                </div>
            <?php endif; ?>

            <?php if (isset($success_message) && $success_message): ?>
                <div class="alert alert-success">
                    <?php echo htmlspecialchars($success_message); ?>
                </div>
            <?php endif; ?>

            <form method="post" action="report_sighting.phtml" onsubmit="return validateForm()">
                <div class="form-group">
                    <label for="pet_id">Select Pet *</label>
                    <select class="form-control" id="pet_id" name="pet_id" required>
                        <option value="">-- Select a lost pet --</option>
                        <?php foreach ($lostPets as $pet): ?>
                            <option value="<?php echo $pet['id']; ?>"
                                    data-reward="<?php echo $pet['total_reward']; ?>"
                                    data-description="<?php echo htmlspecialchars($pet['description']); ?>"
                                    data-photo="<?php echo $pet['photo_url']; ?>">
                                <?php echo htmlspecialchars($pet['name'] . ' - ' . $pet['species'] . ' - Reward: £' . $pet['total_reward']); ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>

                <!-- Pet info display -->
                <div id="petInfo" class="well" style="display: none;">
                    <div class="row">
                        <div class="col-sm-3">
                            <img id="petPhoto" src="" alt="Pet photo" class="img-responsive" style="max-height: 100px;">
                        </div>
                        <div class="col-sm-9">
                            <h4 id="petName"></h4>
                            <p id="petDescription"></p>
                            <p><strong>Total Reward: £<span id="petReward">0</span></strong></p>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="comment">Comment</label>
                    <textarea class="form-control" id="comment" name="comment" rows="3"
                              placeholder="Enter any additional details about the sighting..."></textarea>
                </div>

                <div class="row">
                    <div class="col-sm-4">
                        <div class="form-group">
                            <label for="latitude">Latitude *</label>
                            <input type="text" class="form-control" id="latitude" name="latitude"
                                   placeholder="e.g., 53.4645" required>
                            <small class="text-muted" id="latitudeError" style="display: none; color: red;">Cannot be empty</small>
                        </div>
                    </div>
                    <div class="col-sm-4">
                        <div class="form-group">
                            <label for="longitude">Longitude *</label>
                            <input type="text" class="form-control" id="longitude" name="longitude"
                                   placeholder="e.g., -2.2046" required>
                            <small class="text-muted" id="longitudeError" style="display: none; color: red;">Cannot be empty</small>
                        </div>
                    </div>
                    <div class="col-sm-4">
                        <div class="form-group">
                            <label for="timestamp">Timestamp *</label>
                            <input type="datetime-local" class="form-control" id="timestamp" name="timestamp" required>
                            <small class="text-muted" id="timestampError" style="display: none; color: red;">Cannot be empty</small>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="reward">Additional Reward (£)</label>
                    <input type="number" class="form-control" id="reward" name="reward"
                           min="0" step="0.01" placeholder="0.00" value="0">
                </div>

                <div class="form-group text-center">
                    <button type="submit" name="action" value="save" class="btn btn-primary btn-lg" onclick="return confirmSave()">
                        Save Sighting
                    </button>
                    <button type="submit" name="action" value="delete" class="btn btn-default btn-lg" onclick="return confirmDelete()">
                        Clear Form
                    </button>
                </div>
            </form>

            <div class="text-center" style="margin-top: 30px;">
                <a href="../index.php" class="btn btn-default">Home</a>
                <a href="help.php" class="btn btn-default">Help</a>
                <a href="view_sightings.php" class="btn btn-default">View My Sightings</a>
            </div>
        </div>
    </div>

    <script>
        // Show pet info when a pet is selected
        document.getElementById('pet_id').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const petInfo = document.getElementById('petInfo');

            if (this.value) {
                document.getElementById('petName').textContent = selectedOption.text.split(' - ')[0];
                document.getElementById('petDescription').textContent = selectedOption.getAttribute('data-description');
                document.getElementById('petReward').textContent = selectedOption.getAttribute('data-reward');
                document.getElementById('petPhoto').src = '../images/' + selectedOption.getAttribute('data-photo');
                petInfo.style.display = 'block';
            } else {
                petInfo.style.display = 'none';
            }
        });

        // Form validation
        function validateForm() {
            let isValid = true;
            const latitude = document.getElementById('latitude');
            const longitude = document.getElementById('longitude');
            const timestamp = document.getElementById('timestamp');

            // Check required fields
            if (!latitude.value.trim()) {
                document.getElementById('latitudeError').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('latitudeError').style.display = 'none';
            }

            if (!longitude.value.trim()) {
                document.getElementById('longitudeError').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('longitudeError').style.display = 'none';
            }

            if (!timestamp.value) {
                document.getElementById('timestampError').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('timestampError').style.display = 'none';
            }

            return isValid;
        }

        // Confirmation functions
        function confirmSave() {
            return confirm("Are you sure you want to save this sighting?");
        }

        function confirmDelete() {
            return confirm("Are you sure you want to clear the form? All entered data will be lost.");
        }
    </script>

<?php include 'template/footer.phtml'; ?>